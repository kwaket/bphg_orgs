{% extends 'strains_supply/base.html' %}

{% load django_bootstrap5 %}

{% block content %}

<div class="row justify-content-center">
  <div class="col col-md-8 col-lg-8">
    <h1>Прием поставки №{{ supply.pk }}</h1>

    {% include 'strains_supply/snippets/supply_details_card.html' with supply=supply %}

    <ol class="form-steps form-steps-3">
      <li class="form-step {% if step == 1 %}active{% elif step > 1%} success{% endif %}">
        <div class="step-icon">
          <span class="bi bi-calendar-check"></span>
        </div>
        <span class="step-description">Дата приема<span></li>
      <li class="form-step {% if step == 2 %}active{% elif step > 2%} success{% endif %}">
        <div class="step-icon">
          <span class="bi bi-list-ul"></span>
        </div>
        <span class="step-description">Содержимое поставки</li>
      <li class="form-step {% if step == 3 %}active{% elif step > 3%} success{% endif %}">
        <div class="step-icon">
          <span class="bi bi-chat-left-text"></span>
        </div>
        <span class="step-description">Коментарий</li>
    </ol>
    {% if step == 2 %}
    <form method="POST" id="form-container" class="post-form">
      {% csrf_token %}
      {{ formset.management_form }}
      <div class="row">
        <div class="col col-md-6">
        Вид
        </div>
        <div class="col col-md-5">
        Штамм
        </div>
        <div class="col col-md-1">
        </div>
      </div>
      <hr>
      {% for form in formset %}
      <div class="sample-form">
        {% bootstrap_field form.supply %}
        <div class="row">
          <div class="col col-md-6">
          {% bootstrap_field form.bacteria_type show_label=False size='sm' %}
          </div>
          <div class="col col-md-5">
          {% bootstrap_field form.strain show_label=False size='sm' %}
          </div>
          <div class="col col-md-1">
            {% if not forloop.first %}
            <button class="btn btn-danger btn-sm btn-delete-item">
              <span class="bi bi-trash"></span>
            </button>
            <div style="display: none">
            {% bootstrap_field form.DELETE %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}

      <div class="row justify-content-center add-item-block">
        <div class="col">
          <button id="add-form" class="btn btn-secondary btn-sm" type="button">
            <span class="bi bi-plus-lg"></span> Добавить еще пункт
          </button>
        </div>
      </div>

      <hr>
      <button type="submit" class="btn btn-primary">
        Далее
      </button>
    </form>

    {% else %}
    <form method="POST" class="post-form">{% csrf_token %}
      {% bootstrap_form form %}
      <div class="d-grid gap-2 d-md-flex justify-content-md-start">
        {% if step < 3 %}
        <button type="submit" class="btn btn-primary">
          Далее <span class="bi bi-arrow-right"></span>
        </button>
        {% else %}
        <button type="submit" class="btn btn-success">
          Завершить прием
        </button>
        {% endif %}
     </div>
    </form>
    {% endif %}

    <div>
    </div>
  </div>
</div>

{% endblock %}


{% block scripts %}
{{  block.super }}
<script>
(function() {
  let supplyContentForms = document.querySelectorAll('.sample-form')
  let container = document.querySelector("#form-container")
  let addButton = document.querySelector("#add-form")
  let addButtonsBlock = document.querySelector(".add-item-block")
  let totalForms = document.querySelector("#id_form-TOTAL_FORMS")

  let formNum = supplyContentForms.length - 1
  addButton.addEventListener('click', addForm)

  function addForm(e) {
    e.preventDefault()
    let newForm = supplyContentForms[0].cloneNode(true)
    let formRegex = RegExp(`form-(\\d){1}-`, 'g')
    formNum++
    newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formNum}-`)
    container.insertBefore(newForm, addButtonsBlock)
    totalForms.setAttribute('value', `${formNum+1}`)
  }

  function isDeleteButton(elem) {
    if (elem.tagName.toLowerCase() == 'span') {
      btn = elem.closest('button')
    } else if (elem.tagName.toLowerCase() == 'button') {
      btn = elem
    } else {
      return false
    }
    if (btn.classList.contains('btn-delete-item')) {
      return btn
    }
  }

  container.addEventListener('click', event=> {
    delBtn = isDeleteButton(event.target);
    if (delBtn) {
      event.preventDefault()
      let itemForm = delBtn.closest('.sample-form')
      toDel = itemForm.querySelector('input[type="checkbox"]')
      if (!toDel.checked) {
        toDel.click()
      }
      itemForm.style.display = 'none'
    }
  })

})();

</script>
{% endblock %}

